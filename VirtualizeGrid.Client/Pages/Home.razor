@page "/"
@using Grpc.Net.Client
@using VirtualizedGrid.Protos
@inject GrpcChannel Channel

<h3>Parts List</h3>
<style>
    .content-container {
        padding-bottom: 80px; /* Space for the footer */
    }

    .fixed-footer {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #f8f8f8;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-top: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .progress-bar {
        width: 100%;
        background-color: #e0e0e0;
        height: 20px;
        border-radius: 5px;
        margin-top: 5px;
    }

    .progress {
        background-color: #4caf50;
        height: 100%;
        border-radius: 5px;
        text-align: center;
        color: white;
    }

    .footer-details p {
        margin: 5px 0;
        font-size: 14px;
    }

</style>

<!-- Display parts data -->
<Virtualize Items="@parts" Context="part" ItemSize="50">
    <div style="padding: 5px; border-bottom: 1px solid #ccc;">
        <strong>@part.Name</strong> - @part.Status <br />
        Created on: @part.CreationDate.ToString("yyyy-MM-dd")
    </div>
</Virtualize>

<!-- Fixed Footer for Progress Details -->
<div class="fixed-footer">
    <div class="progress-bar">
        <div class="progress" style="width: @ProgressPercentage%;">@ProgressPercentage% loaded</div>
    </div>
    <div class="footer-details">
        <p>Progress: @ProgressPercentage% | Items Fetched: @ItemsFetched | Data Size: @DataSize MB | Time: @TimeSpentFetching seconds</p>
    </div>
</div>

@code {
    private List<PartDto> parts = new();
    private int ProgressPercentage = 0;
    private int ItemsFetched = 0;
    private double DataSize = 0;
    private double TimeSpentFetching = 0;

    protected override async Task OnInitializedAsync()
    {
        var client = new PartService.PartServiceClient(Channel);
        var request = new PartsRequest { ChunkSize = 10_000 }; // Increased chunk size

        var stopwatch = System.Diagnostics.Stopwatch.StartNew();
        int updateInterval = 10; // Update progress UI every 10 chunks

        using var call = client.GetParts(request);
        try
        {
            while (await call.ResponseStream.MoveNext(CancellationToken.None))
            {
                var batch = call.ResponseStream.Current;

                foreach (var part in batch.Parts)
                {
                    parts.Add(new PartDto
                        {
                            Id = Guid.Parse(part.Id),
                            Name = part.Name,
                            CreationDate = DateTimeOffset.Parse(part.CreationDate),
                            Status = (PartStatus)part.Status
                        });
                    ItemsFetched++;
                }

                ProgressPercentage = (ItemsFetched * 100) / 1_000_000; // Adjust based on your target item count
                DataSize = CalculateDataSize(parts);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            // Handle any exceptions
        }
        finally
        {
            stopwatch.Stop();
            TimeSpentFetching = stopwatch.Elapsed.TotalSeconds;
            StateHasChanged(); // Final UI update after fetching completes
        }
    }

    private double CalculateDataSize(List<PartDto> data)
    {
        // Estimate size per item (16 + 36 + 8 + 4 bytes for each property)
        int sizePerItem = 16 + (36 + 8 + 4);
        return (data.Count * sizePerItem) / (1024.0 * 1024.0);
    }

    public class PartDto
    {
        public Guid Id { get; set; }
        public string Name { get; set; }
        public DateTimeOffset CreationDate { get; set; }
        public PartStatus Status { get; set; }
    }

    public enum PartStatus
    {
        Available,
        OutOfStock,
        Discontinued,
        BackOrder
    }
}
